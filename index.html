<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>OW Ë¥¶Âè∑ÁÆ°ÁêÜÁ≥ªÁªü Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #07090f; --panel: #111722; --line: #2d3748; --accent: #f6ad55;
            --text-main: #e2e8f0; --text-dim: #718096; --white: #ffffff;
            --danger: #fc8181; --success: #68d391; --blue: #63b3ed;
            --tank-color: #63b3ed; --dmg-color: #fc8181; --sup-color: #68d391;
        }
        body { background: var(--bg); color: var(--text-main); font-family: 'Barlow Condensed', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-left: 4px solid var(--accent); padding-left: 15px; }
        h2 { color: var(--accent); font-family: 'Share Tech Mono'; margin: 0; font-size: 24px; }
        #autoRefreshTag { font-family: 'Share Tech Mono'; font-size: 12px; color: var(--text-dim); }

        /* ËøáÊª§Á≥ªÁªü */
        .filter-section { background: rgba(255,255,255,0.02); padding: 15px; border: 1px solid var(--line); border-radius: 4px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; }
        .filter-row { display: flex; gap: 8px; align-items: center; }
        .filter-label { color: var(--text-dim); font-size: 11px; font-weight: bold; width: 60px; text-transform: uppercase; }
        .filter-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--line); color: var(--text-dim); padding: 6px 14px; cursor: pointer; border-radius: 2px; font-size: 13px; font-weight: bold; }
        .filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(246,173,85,0.1); }

        /* Ë°®Ê†ºÊ†∑Âºè */
        .card { background: var(--panel); border: 1px solid var(--line); border-radius: 4px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(255,255,255,0.03); color: var(--text-dim); text-align: left; padding: 12px 15px; font-size: 12px; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--line); font-size: 14px; }

        .status-select { background: #000; color: var(--success); border: 1px solid var(--success); padding: 4px 8px; border-radius: 2px; font-family: 'Share Tech Mono'; cursor: pointer; font-size: 12px; }
        .status-select.busy { color: var(--danger); border-color: var(--danger); }

        .btn-group { display: flex; gap: 6px; }
        .btn { background: transparent; border: 1px solid var(--line); color: var(--text-main); padding: 5px 10px; cursor: pointer; font-family: 'Barlow Condensed'; font-weight: 700; border-radius: 2px; font-size: 12px; }
        .btn-copy-acc { border-color: var(--blue); color: var(--blue); }
        .btn-copy-pwd { border-color: var(--accent); color: var(--accent); }
        .btn-edit { border-color: var(--text-dim); color: var(--text-dim); }
        
        .toolbar { margin-top: 20px; display: flex; gap: 12px; }
        .btn-main { background: var(--accent); color: #000; border: none; padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--panel); border: 1px solid var(--accent); padding: 25px; width: 380px; }
        .modal-content input, .modal-content select { width: 100%; background: #000; border: 1px solid var(--line); color: #fff; padding: 10px; margin: 8px 0; box-sizing: border-box; }

        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: var(--accent); color: #000; font-weight: bold; display: none; z-index: 2000; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>SYSTEM // ACCOUNT MANAGEMENT</h2>
        <div id="autoRefreshTag">AUTO SYNCING... <span id="timer">10</span>s</div>
    </header>
    
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-label">POSITION</div>
            <button class="filter-btn active" onclick="setRoleFilter('all', this)">ALL</button>
            <button class="filter-btn" onclick="setRoleFilter('tank', this)">TANK</button>
            <button class="filter-btn" onclick="setRoleFilter('dmg', this)">DAMAGE</button>
            <button class="filter-btn" onclick="setRoleFilter('sup', this)">SUPPORT</button>
        </div>
        <div class="filter-row">
            <div class="filter-label">RANK</div>
            <button class="filter-btn active" onclick="setRankFilter('all', this)">ALL</button>
            <button class="filter-btn" onclick="setRankFilter('bronze', this)">BRONZE</button>
            <button class="filter-btn" onclick="setRankFilter('silver', this)">SILVER</button>
            <button class="filter-btn" onclick="setRankFilter('gold', this)">GOLD</button>
            <button class="filter-btn" onclick="setRankFilter('platinum', this)">PLATINUM</button>
            <button class="filter-btn" onclick="setRankFilter('diamond', this)">DIAMOND</button>
            <button class="filter-btn" onclick="setRankFilter('master', this)">MASTER</button>
        </div>
    </div>
    
    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Ê∏∏Êàè ID</th>
                    <th>TANK / DMG / SUP</th>
                    <th>Âø´Êç∑Êìç‰Ωú</th>
                    <th>Áä∂ÊÄÅ (‰ΩøÁî®ËÄÖ)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="toolbar">
        <button class="btn-main" onclick="openModal('addModal')">+ Ê∑ªÂä†Êñ∞Ë¥¶Âè∑</button>
        <button class="btn-danger" onclick="openDeleteModal()">√ó Âà†Èô§Ë¥¶Âè∑</button>
        <button class="btn" onclick="openUserModal()" style="color:var(--text-dim); margin-left:auto">üë• ÊàêÂëòÁÆ°ÁêÜ</button>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content" style="border-color:var(--danger)">
        <h3 style="color:var(--danger); margin-top:0">DELETE ACCOUNT</h3>
        <select id="delSelect"></select>
        <div style="display:flex; gap:10px; margin-top:15px">
            <button class="btn-main" style="flex:1; background:var(--danger)" onclick="submitDelete()">Á°ÆËÆ§Âà†Èô§</button>
            <button class="btn" onclick="closeModal('deleteModal')" style="color:#fff">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<div id="editRankModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0">UPDATE RANKS</h3>
        <p id="editIdDisplay" style="color:var(--white); font-weight:bold; margin-bottom:10px"></p>
        <input type="hidden" id="editRowIndex">
        <input type="text" id="editTank" placeholder="TANK">
        <input type="text" id="editDmg" placeholder="DAMAGE">
        <input type="text" id="editSup" placeholder="SUPPORT">
        <div style="display:flex; gap:10px; margin-top:15px">
            <button class="btn-main" style="flex:1" onclick="submitRankUpdate()">‰øùÂ≠ò</button>
            <button class="btn" onclick="closeModal('editRankModal')" style="color:#fff">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<div id="addModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0">ADD NEW</h3>
        <input type="text" id="inId" placeholder="Ê∏∏Êàè ID">
        <input type="text" id="inTank" placeholder="Âù¶ÂÖãÊÆµ‰Ωç">
        <input type="text" id="inDmg" placeholder="ËæìÂá∫ÊÆµ‰Ωç">
        <input type="text" id="inSup" placeholder="ËæÖÂä©ÊÆµ‰Ωç">
        <input type="text" id="inAcc" placeholder="Ë¥¶Âè∑">
        <input type="text" id="inPwd" placeholder="ÂØÜÁ†Å">
        <div style="display:flex; gap:10px; margin-top:15px">
            <button class="btn-main" style="flex:1" onclick="submitAdd()">Êèê‰∫§</button>
            <button class="btn" onclick="closeModal('addModal')" style="color:#fff">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin-top:0">MEMBERS</h3>
        <input type="text" id="inUserList" placeholder="ÂêçÂ≠óÈÄóÂè∑ÈöîÂºÄ">
        <div style="display:flex; gap:10px; margin-top:15px">
            <button class="btn-main" style="flex:1" onclick="submitUsers()">ÂêåÊ≠•</button>
            <button class="btn" onclick="closeModal('userModal')" style="color:#fff">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbypJavMcFmDmp39F5yMXTodlPkS68XH1khmpZiJ-zOtYQGFrESo_Wo-vHlsJfEd_c0T/exec'; 
    let accounts = [], users = [], currentRawUsers = "";
    let roleFilter = 'all', rankFilter = 'all';
    let countdown = 10; // Ê†∏ÂøÉ‰øÆÊîπÁÇπÔºöÂàùÂßãËÆæ‰∏∫ 10 Áßí

    async function load(silent = false) {
        if(!silent) document.getElementById('timer').textContent = "...";
        jsonp(`${API_URL}?action=getAll`, (res) => {
            accounts = res.data;
            users = res.users;
            currentRawUsers = res.rawUserStr;
            render();
            if(!silent) countdown = 10; // Âä†ËΩΩÂêéÈáçÁΩÆ
        });
    }

    // Ëá™Âä®Âà∑Êñ∞ÈÄªËæë
    setInterval(() => {
        countdown--;
        if(countdown <= 0) {
            countdown = 10; // Âë®ÊúüÈáçÁΩÆ
            load(true);
        }
        document.getElementById('timer').textContent = countdown;
    }, 1000);

    function render() {
        const body = document.getElementById('tableBody');
        const filtered = accounts.filter(acc => {
            if (roleFilter === 'all' && rankFilter === 'all') return true;
            const targetCols = (roleFilter === 'all') ? ['tank', 'dmg', 'sup'] : [roleFilter];
            return targetCols.some(col => {
                let val = String(acc[col] || '').trim().toLowerCase();
                if (!val || val === 'unranked' || val === '‚Äî') return false;
                if (val.includes('(') || val.includes(')')) return false;
                if (rankFilter !== 'all' && !val.includes(rankFilter)) return false;
                return true;
            });
        });
        body.innerHTML = filtered.map(acc => `
            <tr>
                <td style="font-weight:700; color:white">${acc.id}</td>
                <td>
                    <span style="color:var(--tank-color)">${acc.tank}</span> / 
                    <span style="color:var(--dmg-color)">${acc.dmg}</span> / 
                    <span style="color:var(--sup-color)">${acc.sup}</span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-copy-acc" onclick="copy('${acc.acc}', 'Ë¥¶Âè∑')">Ë¥¶Âè∑</button>
                        <button class="btn btn-copy-pwd" onclick="copy('${acc.pwd}', 'ÂØÜÁ†Å')">ÂØÜÁ†Å</button>
                        <button class="btn btn-edit" onclick="openEditModal(${acc.rowIndex})">‰øÆÊîπ</button>
                    </div>
                </td>
                <td>
                    <select class="status-select ${acc.status!=='Free'?'busy':''}" onchange="updateStatus(${acc.rowIndex}, this.value)">
                        <option value="Free" ${acc.status==='Free'?'selected':''}>üü¢ FREE</option>
                        ${users.map(u => `<option value="${u}" ${acc.status===u?'selected':''}>üî¥ ${u}</option>`).join('')}
                    </select>
                </td>
            </tr>
        `).join('');
    }

    // Êìç‰ΩúÂáΩÊï∞
    function submitDelete() {
        const idx = document.getElementById('delSelect').value;
        const idT = document.getElementById('delSelect').selectedOptions[0].text;
        if(confirm(`Ê∞∏‰πÖÂà†Èô§ [${idT}]Ôºü`)) {
            jsonp(`${API_URL}?action=delete&rowIndex=${idx}`, () => { closeModal('deleteModal'); msg('Â∑≤Âà†Èô§'); load(); });
        }
    }
    function openDeleteModal() {
        document.getElementById('delSelect').innerHTML = accounts.map(a => `<option value="${a.rowIndex}">${a.id}</option>`).join('');
        openModal('deleteModal');
    }
    function submitRankUpdate() {
        const row = document.getElementById('editRowIndex').value;
        const t = encodeURIComponent(document.getElementById('editTank').value);
        const d = encodeURIComponent(document.getElementById('editDmg').value);
        const s = encodeURIComponent(document.getElementById('editSup').value);
        jsonp(`${API_URL}?action=updateRanks&rowIndex=${row}&tank=${t}&dmg=${d}&sup=${s}`, () => { closeModal('editRankModal'); msg('Â∑≤Êõ¥Êñ∞'); load(); });
    }
    function openEditModal(idx) {
        const acc = accounts.find(a => a.rowIndex === idx);
        document.getElementById('editIdDisplay').textContent = acc.id;
        document.getElementById('editRowIndex').value = idx;
        document.getElementById('editTank').value = acc.tank;
        document.getElementById('editDmg').value = acc.dmg;
        document.getElementById('editSup').value = acc.sup;
        openModal('editRankModal');
    }
    function updateStatus(idx, u) { jsonp(`${API_URL}?action=updateStatus&rowIndex=${idx}&user=${encodeURIComponent(u)}`, () => { msg('ÂêåÊ≠•ÊàêÂäü'); load(true); }); }
    function submitAdd() {
        const p = `action=add&id=${el('inId')}&tank=${el('inTank')}&dmg=${el('inDmg')}&sup=${el('inSup')}&acc=${el('inAcc')}&pwd=${el('inPwd')}`;
        jsonp(`${API_URL}?${p}`, () => { closeModal('addModal'); msg('Ê∑ªÂä†ÊàêÂäü'); load(); });
    }
    function submitUsers() { jsonp(`${API_URL}?action=updateUsers&userList=${encodeURIComponent(document.getElementById('inUserList').value)}`, () => { closeModal('userModal'); msg('ÂêçÂçïÂ∑≤Êõ¥Êñ∞'); load(); }); }
    
    // Â∑•ÂÖ∑Á±ª
    function setRoleFilter(r, b) { roleFilter = r; b.parentElement.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); render(); }
    function setRankFilter(r, b) { rankFilter = r; b.parentElement.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); render(); }
    function copy(t, type) { navigator.clipboard.writeText(t); msg(type + ' Â∑≤Â§çÂà∂'); }
    function msg(t) { const el = document.getElementById('toast'); el.textContent = t; el.style.display = 'block'; setTimeout(() => el.style.display='none', 2000); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openUserModal() { document.getElementById('inUserList').value = currentRawUsers; openModal('userModal'); }
    function el(id) { return encodeURIComponent(document.getElementById(id).value); }
    function jsonp(url, cb) {
        const n = 'cb' + Date.now() + Math.floor(Math.random()*1000);
        window[n] = (d) => { cb(d); document.getElementById(n).remove(); delete window[n]; };
        const s = document.createElement('script'); s.id = n; s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + n; document.body.appendChild(s);
    }
    load();
</script>
</body>
</html>
