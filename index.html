<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OW Â· Steam è´¦å·ç®¡ç†</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Vars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #07090f;
  --panel:     #0d1118;
  --panel2:    #111825;
  --line:      #1a2336;
  --line2:     #222f45;
  --accent:    #e8a020;
  --accent2:   #ff5533;
  --blue:      #3a8fff;
  --text:      #b8c8e0;
  --text-dim:  #445566;
  --text-mid:  #6a7d94;
  --white:     #dde8f5;

  --tank:  #5baeff;
  --dmg:   #ff5050;
  --sup:   #40d080;

  --bronze:   #cd7f32;
  --silver:   #a8b8c8;
  --gold:     #f0c040;
  --plat:     #88c0e8;
  --diamond:  #60d0ff;
  --master:   #cc66ff;
}

html, body { height: 100%; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 15px;
  line-height: 1.4;
  overflow-x: hidden;
}

/* â”€â”€ Scanline texture overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.08) 2px,
    rgba(0,0,0,0.08) 4px
  );
  pointer-events: none;
  z-index: 9999;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 16px 40px;
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 20px 0 0;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--line);
  padding-bottom: 16px;
}

.header-logo {
  font-size: 11px;
  font-family: 'Share Tech Mono', monospace;
  color: var(--accent);
  letter-spacing: 3px;
  text-transform: uppercase;
  border: 1px solid var(--accent);
  padding: 5px 10px;
  margin-right: 20px;
  position: relative;
}
.header-logo::before {
  content: '';
  position: absolute;
  top: -4px; left: -4px;
  width: 6px; height: 6px;
  background: var(--accent);
}

.header-title {
  font-size: 28px;
  font-weight: 800;
  color: var(--white);
  letter-spacing: 3px;
  text-transform: uppercase;
  line-height: 1;
}

.header-sub {
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  color: var(--text-dim);
  letter-spacing: 1px;
  margin-top: 3px;
}

.header-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 16px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
}

.status-pill {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 5px 12px;
  border: 1px solid var(--line2);
  border-radius: 2px;
  color: var(--text-dim);
}

.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--text-dim);
  flex-shrink: 0;
}
.status-dot.live {
  background: var(--sup);
  box-shadow: 0 0 8px var(--sup);
  animation: pulse 2s ease-in-out infinite;
}
.status-dot.err { background: var(--dmg); }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* refresh countdown ring */
.refresh-ring {
  position: relative;
  width: 28px; height: 28px;
  flex-shrink: 0;
}
.refresh-ring svg {
  width: 28px; height: 28px;
  transform: rotate(-90deg);
}
.refresh-ring circle {
  fill: none;
  stroke: var(--line2);
  stroke-width: 2.5;
}
.refresh-ring .progress {
  stroke: var(--accent);
  stroke-dasharray: 75.4;
  stroke-dashoffset: 0;
  transition: stroke-dashoffset 1s linear;
}
.refresh-ring .label {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  color: var(--accent);
}



/* â”€â”€ Summary bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.summary {
  display: flex;
  gap: 1px;
  margin-bottom: 16px;
  background: var(--line);
}

.summary-cell {
  flex: 1;
  background: var(--panel);
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.summary-cell .s-label {
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--text-dim);
  text-transform: uppercase;
}
.summary-cell .s-val {
  font-size: 24px;
  font-weight: 800;
  color: var(--white);
  line-height: 1;
}
.summary-cell.in-use .s-val { color: var(--dmg); }
.summary-cell.free .s-val { color: var(--sup); }

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap {
  border: 1px solid var(--line);
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead tr {
  background: var(--panel2);
  border-bottom: 1px solid var(--line2);
}

th {
  padding: 10px 14px;
  text-align: left;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  font-weight: 600;
  white-space: nowrap;
}

tbody tr {
  border-bottom: 1px solid var(--line);
  transition: background 0.12s;
  animation: rowIn 0.3s ease both;
}

@keyframes rowIn {
  from { opacity: 0; transform: translateX(-6px); }
  to   { opacity: 1; transform: translateX(0); }
}

tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(255,255,255,0.018); }

tbody tr.in-use-row {
  background: rgba(255,50,30,0.04);
}
tbody tr.in-use-row:hover {
  background: rgba(255,50,30,0.07);
}

td {
  padding: 11px 14px;
  vertical-align: middle;
}

/* ID cell */
.cell-id {
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px;
  color: var(--white);
  min-width: 140px;
}

/* Rank badge */
.rank {
  display: inline-block;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.5px;
  white-space: nowrap;
  border-left: 2px solid transparent;
}
.rank-unranked   { color: var(--text-dim); }
.rank-bronze     { color: var(--bronze);  border-color: var(--bronze); background: rgba(205,127,50,0.08); }
.rank-silver     { color: var(--silver);  border-color: var(--silver); background: rgba(168,184,200,0.08); }
.rank-gold       { color: var(--gold);    border-color: var(--gold);   background: rgba(240,192,64,0.08); }
.rank-platinum   { color: var(--plat);    border-color: var(--plat);   background: rgba(136,192,232,0.08); }
.rank-diamond    { color: var(--diamond); border-color: var(--diamond);background: rgba(96,208,255,0.08); }
.rank-master     { color: var(--master);  border-color: var(--master); background: rgba(204,102,255,0.08); }
.rank-provisional { opacity: 0.7; font-style: italic; }
.rank-inprogress { animation: blink 2s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* Account cell */
.cell-acc {
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  color: var(--text);
  white-space: nowrap;
}

/* Action buttons */
.actions {
  display: flex;
  gap: 6px;
  align-items: center;
  white-space: nowrap;
}

.act-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 10px;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
  border: 1px solid var(--line2);
  background: transparent;
  color: var(--text-mid);
  transition: all 0.15s;
}
.act-btn:hover { border-color: var(--accent); color: var(--accent); }
.act-btn:active { transform: scale(0.96); }

.act-btn.copy-btn:hover { border-color: var(--blue); color: var(--blue); }
.act-btn.copy-btn.copied {
  border-color: var(--sup);
  color: var(--sup);
}

.act-btn.inuse-btn.active {
  border-color: var(--dmg);
  color: var(--dmg);
  background: rgba(255,85,51,0.08);
}
.act-btn.inuse-btn.active:hover {
  background: rgba(255,85,51,0.15);
}
.act-btn.inuse-btn:not(.active):hover {
  border-color: var(--sup);
  color: var(--sup);
}

/* In-use badge in status col */
.inuse-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-family: 'Share Tech Mono', monospace;
  letter-spacing: 1px;
  padding: 2px 8px;
}
.inuse-badge.on {
  color: var(--dmg);
  border: 1px solid rgba(255,85,51,0.4);
  background: rgba(255,85,51,0.06);
}
.inuse-badge.off {
  color: var(--text-dim);
  border: 1px solid var(--line);
}

/* â”€â”€ Empty / Loading states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.state-box {
  background: var(--panel);
  border: 1px solid var(--line);
  padding: 64px 20px;
  text-align: center;
}
.state-box .icon {
  font-size: 40px;
  margin-bottom: 16px;
}
.state-box h3 {
  font-size: 20px;
  font-weight: 700;
  color: var(--white);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 8px;
}
.state-box p {
  font-size: 13px;
  font-family: 'Share Tech Mono', monospace;
  color: var(--text-dim);
  line-height: 1.8;
}

.loader {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  padding: 48px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  color: var(--text-dim);
  letter-spacing: 2px;
}
.loader-bar {
  width: 120px;
  height: 2px;
  background: var(--line2);
  overflow: hidden;
}
.loader-bar::after {
  content: '';
  display: block;
  height: 100%;
  width: 40%;
  background: var(--accent);
  animation: slide 1s ease-in-out infinite alternate;
}
@keyframes slide { from{transform:translateX(-100%)} to{transform:translateX(350%)} }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  background: var(--panel2);
  border: 1px solid var(--accent);
  border-left: 3px solid var(--accent);
  padding: 10px 18px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px;
  color: var(--accent);
  letter-spacing: 1px;
  opacity: 0;
  transform: translateY(8px);
  transition: all 0.2s;
  pointer-events: none;
  z-index: 10000;
  max-width: 320px;
}
.toast.err { border-color: var(--dmg); color: var(--dmg); }
.toast.ok  { border-color: var(--sup); color: var(--sup); }
.toast.show { opacity: 1; transform: translateY(0); }

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--line2); }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
</style>
</head>
<body>

<div class="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">OW</div>
    <div>
      <div class="header-title">Steam Account Manager</div>
      <div class="header-sub">å®ˆæœ›å…ˆé”‹ Â· è´¦å·ç®¡ç†ç³»ç»Ÿ</div>
    </div>
    <div class="header-right">
      <div class="status-pill">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">æœªè¿æ¥</span>
      </div>
      <!-- Refresh countdown ring -->
      <div class="refresh-ring" id="refreshRing" title="è·ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°" style="display:none">
        <svg viewBox="0 0 28 28">
          <circle cx="14" cy="14" r="12"/>
          <circle class="progress" id="ringProgress" cx="14" cy="14" r="12"/>
        </svg>
        <div class="label" id="ringLabel">60</div>
      </div>
    </div>
  </header>

  <!-- Summary -->
  <div class="summary" id="summary" style="display:none">
    <div class="summary-cell">
      <div class="s-label">æ€»è´¦å·</div>
      <div class="s-val" id="sTotal">0</div>
    </div>
    <div class="summary-cell in-use">
      <div class="s-label">ä½¿ç”¨ä¸­</div>
      <div class="s-val" id="sInUse">0</div>
    </div>
    <div class="summary-cell free">
      <div class="s-label">ç©ºé—²</div>
      <div class="s-val" id="sFree">0</div>
    </div>
    <div class="summary-cell" style="flex:2">
      <div class="s-label">ä¸Šæ¬¡æ›´æ–°</div>
      <div class="s-val" style="font-size:16px; color:var(--text-mid)" id="sTime">â€”</div>
    </div>
  </div>

  <!-- Table -->
  <div id="tableArea">
    <div class="state-box">
      <div class="icon">ğŸ®</div>
      <h3>æ­£åœ¨è¿æ¥</h3>
      <p>æ­£åœ¨åŠ è½½è´¦å·æ•°æ®ï¼Œè¯·ç¨å€™â€¦</p>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ================================================================
// CONFIG â€” ä¿®æ”¹è¿™é‡Œ
// ================================================================

// ã€å¿…å¡«ã€‘å°† Code.gs éƒ¨ç½²ä¸º Web App åï¼ŒæŠŠéƒ¨ç½² URL ç²˜è´´åˆ°è¿™é‡Œ
// éƒ¨ç½²æ­¥éª¤ï¼šApps Script â†’ éƒ¨ç½² â†’ æ–°å»ºéƒ¨ç½² â†’ ç±»å‹ã€ŒWeb åº”ç”¨ã€
//           æ‰§è¡Œèº«ä»½ï¼šã€Œæˆ‘ã€ / è®¿é—®æƒé™ï¼šã€Œæ‰€æœ‰äººã€
// æ¯æ¬¡ä¿®æ”¹ Code.gs åé¡»é‡æ–°éƒ¨ç½²ï¼ˆç‰ˆæœ¬é€‰ã€Œæ–°å»ºç‰ˆæœ¬ã€ï¼‰å¹¶æ›´æ–°æ­¤ URL
const API_URL = 'https://script.google.com/macros/s/AKfycbypJavMcFmDmp39F5yMXTodlPkS68XH1khmpZiJ-zOtYQGFrESo_Wo-vHlsJfEd_c0T/exec';

// è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰
const REFRESH_INTERVAL = 60;

// ================================================================
// STATE â€” è¿è¡Œæ—¶çŠ¶æ€ï¼Œå‹¿ä¿®æ”¹
// ================================================================
let apiUrl = API_URL;
let accounts = [];
let refreshTimer = null;
let countdownTimer = null;
let countdown = REFRESH_INTERVAL;
let pendingInUse = new Set(); // æ­£åœ¨å†™å› Sheets çš„è¡Œç´¢å¼•é›†åˆ

// â”€â”€ Rank parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseRank(raw) {
  const s = String(raw || '').trim();
  if (!s || s.toLowerCase() === 'unranked') return { html: '<span class="rank rank-unranked">â€”</span>', tier: '' };

  let isProvisional = /^[\(ï¼ˆ].*[\)ï¼‰]$/.test(s);
  let isInProgress  = /^-.*-$/.test(s);
  let inner = isProvisional ? s.slice(1, -1) : isInProgress ? s.slice(1, -1) : s;
  const low = inner.toLowerCase();

  let cls = '';
  if      (low.includes('bronze'))                       cls = 'rank-bronze';
  else if (low.includes('sliver') || low.includes('silver')) cls = 'rank-silver';
  else if (low.includes('gold'))                         cls = 'rank-gold';
  else if (low.includes('platinum') || low.includes('plat')) cls = 'rank-platinum';
  else if (low.includes('diamond'))                      cls = 'rank-diamond';
  else if (low.includes('master') || low.includes('grand')) cls = 'rank-master';

  const extras = [cls, isProvisional ? 'rank-provisional' : '', isInProgress ? 'rank-inprogress' : ''].filter(Boolean).join(' ');
  const prefix = isInProgress ? 'â–¸ ' : isProvisional ? 'â—ˆ ' : '';
  return { html: `<span class="rank ${extras}">${prefix}${esc(inner)}</span>`, tier: cls };
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  if (!accounts.length) {
    document.getElementById('tableArea').innerHTML = `
      <div class="state-box">
        <div class="icon">ğŸ“­</div>
        <h3>æ²¡æœ‰æ•°æ®</h3>
        <p>è¡¨æ ¼ä¸­æœªæ‰¾åˆ°è´¦å·æ•°æ®ï¼Œè¯·æ£€æŸ¥ Sheet æ ‡ç­¾åå’Œè¡¨å¤´æ ¼å¼ã€‚</p>
      </div>`;
    return;
  }

  const rows = accounts.map((acc, i) => {
    const inUse = acc.inUse;
    const pending = pendingInUse.has(acc.rowIndex);
    const tank = parseRank(acc.tank).html;
    const dmg  = parseRank(acc.damage).html;
    const sup  = parseRank(acc.support).html;

    return `<tr class="${inUse ? 'in-use-row' : ''}" id="row-${i}">
      <td><span class="cell-id">${esc(acc.id)}</span></td>
      <td>${tank}</td>
      <td>${dmg}</td>
      <td>${sup}</td>
      <td class="cell-acc">${esc(acc.account)}</td>
      <td>
        <div class="inuse-badge ${inUse ? 'on' : 'off'}">
          <span>${inUse ? 'â— IN USE' : 'â—‹ FREE'}</span>
        </div>
      </td>
      <td>
        <div class="actions">
          <button class="act-btn copy-btn" onclick="copyAccount(${i})" id="copy-${i}">
            â§‰ å¤åˆ¶è´¦å¯†
          </button>
          <button class="act-btn inuse-btn ${inUse ? 'active' : ''}"
            onclick="toggleInUse(${i})"
            id="inuse-${i}"
            ${pending ? 'disabled' : ''}>
            ${pending ? 'â€¦' : inUse ? 'âœ• é‡Šæ”¾' : 'âœ“ å ç”¨'}
          </button>
        </div>
      </td>
    </tr>`;
  }).join('');

  document.getElementById('tableArea').innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>æ¸¸æˆ ID</th>
            <th style="color:var(--tank)">ğŸ›¡ å¦å…‹</th>
            <th style="color:var(--dmg)">âš” è¾“å‡º</th>
            <th style="color:var(--sup)">ğŸ’š è¾…åŠ©</th>
            <th>è´¦å·</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

  // Summary
  const total  = accounts.length;
  const inUseN = accounts.filter(a => a.inUse).length;
  document.getElementById('sTotal').textContent = total;
  document.getElementById('sInUse').textContent = inUseN;
  document.getElementById('sFree').textContent  = total - inUseN;
  document.getElementById('sTime').textContent  = new Date().toLocaleTimeString('zh-CN');
  document.getElementById('summary').style.display = 'flex';
}

// â”€â”€ Copy account + password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyAccount(i) {
  const acc = accounts[i];
  const text = `${acc.account}\n${acc.password}`;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById(`copy-${i}`);
    btn.textContent = 'âœ“ å·²å¤åˆ¶';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'â§‰ å¤åˆ¶è´¦å¯†';
      btn.classList.remove('copied');
    }, 2000);
  }).catch(() => toast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'err'));
}


// â”€â”€ JSONP helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Apps Script Web App çš„ fetch/XHR è¯·æ±‚ä¼šè¢«æµè§ˆå™¨ CORS ç­–ç•¥æ‹¦æˆªï¼Œ
// æ ¹æœ¬åŸå› ï¼šGoogle çš„é‡å®šå‘é“¾ä¼šä¸¢å¤± Access-Control-Allow-Origin å¤´ã€‚
// è§£å†³æ–¹æ¡ˆï¼šJSONP â€”â€” åŠ¨æ€æ³¨å…¥ <script> æ ‡ç­¾ï¼Œç»•è¿‡åŒæºé™åˆ¶ã€‚
// Apps Script ä¾§éœ€è¦è¯»å– callback å‚æ•°å¹¶ç”¨ callback(json) æ ¼å¼è¾“å‡ºã€‚

function jsonp(url, timeout = 10000) {
  return new Promise((resolve, reject) => {
    const cbName = '__owCb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
    const script = document.createElement('script');

    const timer = setTimeout(() => {
      _jsonpCleanup(script, cbName);
      reject(new Error('è¯·æ±‚è¶…æ—¶'));
    }, timeout);

    window[cbName] = function(data) {
      clearTimeout(timer);
      _jsonpCleanup(script, cbName);
      resolve(data);
    };

    script.onerror = function() {
      clearTimeout(timer);
      _jsonpCleanup(script, cbName);
      reject(new Error('è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤ Apps Script å·²éƒ¨ç½²ä¸”è®¿é—®æƒé™ä¸ºã€Œæ‰€æœ‰äººã€'));
    };

    // æ‹¼æ¥ callback å‚æ•°ååˆ° URL
    const sep = url.includes('?') ? '&' : '?';
    script.src = `${url}${sep}callback=${cbName}&t=${Date.now()}`;
    document.head.appendChild(script);
  });
}

function _jsonpCleanup(script, cbName) {
  if (script && script.parentNode) script.parentNode.removeChild(script);
  delete window[cbName];
}

// â”€â”€ Fetch data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fetchData(silent = false) {
  if (!apiUrl) return;
  if (!silent) {
    document.getElementById('tableArea').innerHTML = `
      <div class="loader">
        <div class="loader-bar"></div>
        <span>LOADING DATA...</span>
      </div>`;
  }

  jsonp(`${apiUrl}?action=getAll`)
    .then(json => {
      if (!json.ok) throw new Error(json.error || 'Bad response');
      accounts = json.data;
      setStatus('live', `å·²è¿æ¥ Â· ${accounts.length} ä¸ªè´¦å·`);
      render();
    })
    .catch(e => {
      if (!silent) {
        document.getElementById('tableArea').innerHTML = `
          <div class="state-box">
            <div class="icon">âš ï¸</div>
            <h3>åŠ è½½å¤±è´¥</h3>
            <p>${esc(e.message)}</p>
          </div>`;
      }
      setStatus('err', 'è¿æ¥å¤±è´¥');
      if (!silent) toast('åŠ è½½å¤±è´¥ï¼š' + e.message, 'err');
    });
}

// â”€â”€ Toggle In Use â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å†™æ“ä½œåŒæ ·ç”¨ JSONP GETï¼Œå‚æ•°ç›´æ¥ç¼–è¿› URL query stringã€‚
// Apps Script doGet çš„ e.parameter å¯ç›´æ¥è¯»å–æ‰€æœ‰ query å‚æ•°ã€‚
async function toggleInUse(i) {
  const acc = accounts[i];
  const newVal = !acc.inUse;

  pendingInUse.add(acc.rowIndex);
  render();

  try {
    const json = await jsonp(`${apiUrl}?action=setInUse&rowIndex=${acc.rowIndex}&inUse=${newVal}`);
    if (!json.ok) throw new Error(json.error || 'Unknown error');
    accounts[i].inUse = newVal;
    toast(newVal ? `å·²æ ‡è®°ã€Œ${acc.id}ã€ä¸ºä½¿ç”¨ä¸­` : `å·²é‡Šæ”¾ã€Œ${acc.id}ã€`, 'ok');
  } catch (e) {
    toast('æ›´æ–°å¤±è´¥ï¼š' + e.message, 'err');
  } finally {
    pendingInUse.delete(acc.rowIndex);
    render();
  }
}


// â”€â”€ Auto refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAutoRefresh() {
  clearInterval(refreshTimer);
  clearInterval(countdownTimer);

  document.getElementById('refreshRing').style.display = 'flex';
  resetCountdown();

  refreshTimer = setInterval(() => {
    fetchData(true);
    resetCountdown();
  }, REFRESH_INTERVAL * 1000);
}

function resetCountdown() {
  countdown = REFRESH_INTERVAL;
  updateRing();
  clearInterval(countdownTimer);
  countdownTimer = setInterval(() => {
    countdown--;
    if (countdown < 0) countdown = 0;
    updateRing();
  }, 1000);
}

function updateRing() {
  const circumference = 75.4;
  const offset = circumference * (1 - countdown / REFRESH_INTERVAL);
  document.getElementById('ringProgress').style.strokeDashoffset = offset;
  document.getElementById('ringLabel').textContent = countdown;
}

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state, text) {
  const dot  = document.getElementById('statusDot');
  const span = document.getElementById('statusText');
  dot.className = `status-dot ${state}`;
  span.textContent = text;
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Init â€” é¡µé¢åŠ è½½åè‡ªåŠ¨è¿æ¥ï¼Œæ— éœ€ç”¨æˆ·æ“ä½œ â”€â”€â”€â”€â”€â”€â”€
(function init() {
  // æ£€æŸ¥å ä½ç¬¦æ˜¯å¦å·²æ›¿æ¢
  if (API_URL.includes('REPLACE_WITH_YOUR_DEPLOYMENT_ID')) {
    document.getElementById('tableArea').innerHTML = `
      <div class="state-box">
        <div class="icon">âš™ï¸</div>
        <h3>å¾…é…ç½®</h3>
        <p>è¯·åœ¨ index.html é¡¶éƒ¨ CONFIG åŒºåŸŸ<br>å°† API_URL æ›¿æ¢ä¸ºå®é™…çš„ Apps Script éƒ¨ç½² URLã€‚</p>
      </div>`;
    setStatus('err', 'æœªé…ç½® API URL');
    return;
  }
  // URL å·²é…ç½®ï¼Œç›´æ¥å¯åŠ¨
  startAutoRefresh();
  fetchData(false);
})();
</script>
</body>
</html>
